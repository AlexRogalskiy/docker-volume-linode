
sudo: required

#language: ruby

services:
  - docker

#before_install:
#- docker pull carlad/sinatra
#- docker run -d -p 127.0.0.1:80:4567 carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec foreman start;"
#- docker ps -a
#- docker run carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec rake test"

#script:
#- bundle exec rake test


language: go

env:
  global:
    - PLUGIN_NAME_ROOTFS=docker-volume-linode:rootfs-${TRAVIS_BUILD_NUMBER}
    - PLUGIN_NAME=docker-volume-linode:${TRAVIS_TAG}.${TRAVIS_BUILD_NUMBER}

before_install:
  - go get -u github.com/golang/dep/cmd/dep
  - echo "### docker build: rootfs image with docker-volume-linode"
  - dep ensure
  - docker build --no-cache -q -t ${PLUGIN_NAME_ROOTFS} .
  - echo "### create rootfs directory in ./plugin/rootfs"
  - mkdir -p ./plugin/rootfs
  - docker create --name tmp  ${PLUGIN_NAME_ROOTFS}
  - docker export tmp | tar -x -C ./plugin/rootfs
  - echo "### copy config.json to ./plugin/"
  - cp config.json ./plugin/
  - docker rm -vf tmp
  - echo "### remove existing plugin ${PLUGIN_NAME} if exists"
  - docker plugin rm -f ${PLUGIN_NAME} || true
  - echo "### create new plugin ${PLUGIN_NAME} from ./plugin"
  - docker plugin create ${PLUGIN_NAME} ./plugin

script:
  - echo "### push plugin ${PLUGIN_NAME}:${PLUGIN_TAG}"
  - docker plugin push ${PLUGIN_NAME}

deploy:
  provider: script
  script: bash docker_push
  on:
    branch: master

